---
import { render } from "astro:content";
import starlightRapidocConfig from "virtual:starlight-rapidoc-config";
import ContentPanel from "@astrojs/starlight/components/ContentPanel.astro";
import MarkdownContent from "@astrojs/starlight/components/MarkdownContent.astro";
import Default from "@astrojs/starlight/components/TwoColumnContent.astro";

const hexColorBgLight = starlightRapidocConfig.hexColorBgLight;
const hexColorBgDark = starlightRapidocConfig.hexColorBgDark;
const hexColorFgLight = starlightRapidocConfig.hexColorFgLight;
const hexColorFgDark = starlightRapidocConfig.hexColorFgDark;

const { starlightRoute } = Astro.locals;

const entry = Astro.locals.starlightRoute.entry;
const {
	specFile,
	serverUrl,
	allowTry,
	allowSpecDownload,
	allowServerSelection,
} = entry.data;
const isOpenApiPage = !!specFile;

// Render the entry to get just the markdown content (without page wrapper)
const { Content: MarkdownBody } = isOpenApiPage
	? await render(entry)
	: { Content: null };
---
{isOpenApiPage ? (
    <script slot="head" src="https://unpkg.com/rapidoc/dist/rapidoc-min.js"></script>
    <main
					lang={starlightRoute.entryMeta.lang}
					dir={starlightRoute.entryMeta.dir}
				>



    <div class="markdown-container">
      <MarkdownContent>
        {MarkdownBody && <MarkdownBody />}
      </MarkdownContent>
    </div>
    <div class="rapidoc-container">
      <rapi-doc
        id="rapidoc"
        layout="column"
        render-style="view"
        spec-url={specFile}
        schema-style="table"
        schema-description-expanded="true"
        primary-color="#0063a3"hub87n
        show-header="false"
        server-url={serverUrl}
        default-api-server={serverUrl}
        allow-server-selection={allowServerSelection?.toString()}
        allow-try={allowTry?.toString()}
        allow-authentication={allowTry?.toString()}
        allow-spec-file-download={allowSpecDownload?.toString()}
      />
    </div>
  </main>
) : (
  <Default>
    <slot />
  </Default>
)}

{isOpenApiPage && (
  <>
    <style>
      .markdown-container {
        margin-top: 2rem;
        padding-inline: 2rem;
        width: 100%;
      }
      
      .rapidoc-container {
        width: 100%;
      }

      rapi-doc {
        width: 100%;
        padding-inline: 1rem;
        padding-top: 1rem;
      }
    </style>

    <script define:vars={{ hexColorBgDark, hexColorFgDark, hexColorBgLight, hexColorFgLight }}>
      console.log(`hexColorBgDark: ${hexColorBgDark}`);
      console.log(`hexColorFgDark: ${hexColorFgDark}`);
      console.log(`hexColorBgLight: ${hexColorBgLight}`);
      console.log(`hexColorFgLight: ${hexColorFgLight}`);

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'data-theme') {
            const theme = document.documentElement.getAttribute('data-theme') || "dark";
            setRapidocTheme(theme);
          }
        });
      });

      observer.observe(document.documentElement, { attributes: true });

      const rapiDoc = document.querySelector("#rapidoc");

      const setRapidocTheme = (theme = "dark") => {
        if (!rapiDoc) return;
        rapiDoc.setAttribute("theme", theme);
        if (theme === "dark") {
          rapiDoc.setAttribute("bg-color", `${hexColorBgDark}`);
          rapiDoc.setAttribute("text-color", `${hexColorFgDark}`);
        } else {
          rapiDoc.setAttribute("bg-color", `${hexColorBgLight}`);
          rapiDoc.setAttribute("text-color", `${hexColorFgLight}`);
        }
      };

      window.addEventListener("DOMContentLoaded", () => {
        const theme = document.documentElement.getAttribute('data-theme') || "dark";
        setRapidocTheme(theme);
      });
    </script>
  </>
)}
